name: Monitoring - Usage Report & Alerts

on:
  schedule:
    # 6ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰ (UTC ê¸°ì¤€)
    - cron: '0 */6 * * *'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

env:
  AWS_REGION: ap-northeast-2
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}
  PROJECT_DIR: ${{ secrets.EC2_PROJECT_DIR }}
  PROMETHEUS_URL: http://localhost:9090

jobs:
  monitor:
    name: Monitor System Usage
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/ec2_key
          chmod 600 ~/.ssh/ec2_key
          ssh-keyscan -H ${{ env.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Restore Previous Metrics
        uses: actions/cache@v3
        id: metrics_cache
        with:
          path: metrics_cache
          key: monitoring-metrics-${{ github.repository }}

      - name: Get Previous Metrics
        id: previous_metrics
        run: |
          # ì´ì „ ë©”íŠ¸ë¦­ ê°’ì„ ê°€ì ¸ì˜¤ê¸°
          PREVIOUS_CPU=$(cat metrics_cache/cpu.txt 2>/dev/null || echo "0")
          PREVIOUS_MEMORY=$(cat metrics_cache/memory.txt 2>/dev/null || echo "0")
          PREVIOUS_REDIS=$(cat metrics_cache/redis.txt 2>/dev/null || echo "0")
          PREVIOUS_POSTGRES=$(cat metrics_cache/postgres.txt 2>/dev/null || echo "0")
          
          echo "previous_cpu=$PREVIOUS_CPU" >> $GITHUB_OUTPUT
          echo "previous_memory=$PREVIOUS_MEMORY" >> $GITHUB_OUTPUT
          echo "previous_redis=$PREVIOUS_REDIS" >> $GITHUB_OUTPUT
          echo "previous_postgres=$PREVIOUS_POSTGRES" >> $GITHUB_OUTPUT

      - name: Fetch Current Metrics from Prometheus
        id: current_metrics
        run: |
          ssh -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no ${{ env.EC2_USER }}@${{ env.EC2_HOST }} << 'ENDSSH'
            set -e
            
            echo "ğŸ“Š Prometheusì—ì„œ ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ì¤‘..."
            
            # Prometheus APIë¥¼ ì‚¬ìš©í•˜ì—¬ ë©”íŠ¸ë¦­ ì¡°íšŒ
            PROMETHEUS_URL="http://localhost:9090"
            
            # CPU ì‚¬ìš©ë¥  (ë°±ì—”ë“œ í”„ë¡œì„¸ìŠ¤)
            CPU_QUERY='irate(process_cpu_seconds_total{job="fastapi-backend"}[5m])*100'
            CPU_RESPONSE=$(curl -s "${PROMETHEUS_URL}/api/v1/query?query=${CPU_QUERY}" || echo '{"status":"error"}')
            CPU_VALUE=$(echo "$CPU_RESPONSE" | grep -o '"value":\[[0-9]*\.[0-9]*,"[0-9.]*"\]' | head -1 | grep -o '"[0-9.]*"' | tail -1 | tr -d '"' || echo "0")
            
            # ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥  (ë°±ì—”ë“œ í”„ë¡œì„¸ìŠ¤)
            MEMORY_QUERY='process_resident_memory_bytes{job="fastapi-backend"}/1024/1024/1024'
            MEMORY_RESPONSE=$(curl -s "${PROMETHEUS_URL}/api/v1/query?query=${MEMORY_QUERY}" || echo '{"status":"error"}')
            MEMORY_VALUE=$(echo "$MEMORY_RESPONSE" | grep -o '"value":\[[0-9]*\.[0-9]*,"[0-9.]*"\]' | head -1 | grep -o '"[0-9.]*"' | tail -1 | tr -d '"' || echo "0")
            
            # Redis ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ 
            REDIS_QUERY='100 * (redis_memory_used_bytes / redis_memory_max_bytes)'
            REDIS_RESPONSE=$(curl -s "${PROMETHEUS_URL}/api/v1/query?query=${REDIS_QUERY}" || echo '{"status":"error"}')
            REDIS_VALUE=$(echo "$REDIS_RESPONSE" | grep -o '"value":\[[0-9]*\.[0-9]*,"[0-9.]*"\]' | head -1 | grep -o '"[0-9.]*"' | tail -1 | tr -d '"' || echo "0")
            
            # PostgreSQL ì—°ê²° ìˆ˜
            POSTGRES_QUERY='pg_stat_database_numbackends{datname="realestate"}'
            POSTGRES_RESPONSE=$(curl -s "${PROMETHEUS_URL}/api/v1/query?query=${POSTGRES_QUERY}" || echo '{"status":"error"}')
            POSTGRES_VALUE=$(echo "$POSTGRES_RESPONSE" | grep -o '"value":\[[0-9]*\.[0-9]*,"[0-9.]*"\]' | head -1 | grep -o '"[0-9.]*"' | tail -1 | tr -d '"' || echo "0")
            
            # HTTP ìš”ì²­ ìˆ˜ (1ë¶„ë‹¹)
            HTTP_QUERY='rate(http_requests_total{job="fastapi-backend"}[1m])'
            HTTP_RESPONSE=$(curl -s "${PROMETHEUS_URL}/api/v1/query?query=${HTTP_QUERY}" || echo '{"status":"error"}')
            HTTP_VALUE=$(echo "$HTTP_RESPONSE" | grep -o '"value":\[[0-9]*\.[0-9]*,"[0-9.]*"\]' | head -1 | grep -o '"[0-9.]*"' | tail -1 | tr -d '"' || echo "0")
            
            # ì—ëŸ¬ìœ¨
            ERROR_QUERY='rate(http_requests_total{job="fastapi-backend",status=~"5.."}[1m])'
            ERROR_RESPONSE=$(curl -s "${PROMETHEUS_URL}/api/v1/query?query=${ERROR_QUERY}" || echo '{"status":"error"}')
            ERROR_VALUE=$(echo "$ERROR_RESPONSE" | grep -o '"value":\[[0-9]*\.[0-9]*,"[0-9.]*"\]' | head -1 | grep -o '"[0-9.]*"' | tail -1 | tr -d '"' || echo "0")
            
            # ê²°ê³¼ ì¶œë ¥
            echo "CPU_USAGE=$CPU_VALUE"
            echo "MEMORY_USAGE=$MEMORY_VALUE"
            echo "REDIS_USAGE=$REDIS_VALUE"
            echo "POSTGRES_CONNECTIONS=$POSTGRES_VALUE"
            echo "HTTP_RATE=$HTTP_VALUE"
            echo "ERROR_RATE=$ERROR_VALUE"
          ENDSSH > metrics_output.txt || echo "CPU_USAGE=0
MEMORY_USAGE=0
REDIS_USAGE=0
POSTGRES_CONNECTIONS=0
HTTP_RATE=0
ERROR_RATE=0" > metrics_output.txt
          
          # ë©”íŠ¸ë¦­ ê°’ íŒŒì‹±
          CPU_USAGE=$(grep "CPU_USAGE=" metrics_output.txt | cut -d'=' -f2 || echo "0")
          MEMORY_USAGE=$(grep "MEMORY_USAGE=" metrics_output.txt | cut -d'=' -f2 || echo "0")
          REDIS_USAGE=$(grep "REDIS_USAGE=" metrics_output.txt | cut -d'=' -f2 || echo "0")
          POSTGRES_CONNECTIONS=$(grep "POSTGRES_CONNECTIONS=" metrics_output.txt | cut -d'=' -f2 || echo "0")
          HTTP_RATE=$(grep "HTTP_RATE=" metrics_output.txt | cut -d'=' -f2 || echo "0")
          ERROR_RATE=$(grep "ERROR_RATE=" metrics_output.txt | cut -d'=' -f2 || echo "0")
          
          echo "current_cpu=$CPU_USAGE" >> $GITHUB_OUTPUT
          echo "current_memory=$MEMORY_USAGE" >> $GITHUB_OUTPUT
          echo "current_redis=$REDIS_USAGE" >> $GITHUB_OUTPUT
          echo "current_postgres=$POSTGRES_CONNECTIONS" >> $GITHUB_OUTPUT
          echo "current_http_rate=$HTTP_RATE" >> $GITHUB_OUTPUT
          echo "current_error_rate=$ERROR_RATE" >> $GITHUB_OUTPUT
          
          # ìºì‹œ ë””ë ‰í† ë¦¬ ìƒì„± ë° ê°’ ì €ì¥
          mkdir -p metrics_cache
          echo "$CPU_USAGE" > metrics_cache/cpu.txt
          echo "$MEMORY_USAGE" > metrics_cache/memory.txt
          echo "$REDIS_USAGE" > metrics_cache/redis.txt
          echo "$POSTGRES_CONNECTIONS" > metrics_cache/postgres.txt

      - name: Save Metrics to Cache
        uses: actions/cache@v3
        with:
          path: metrics_cache
          key: monitoring-metrics-${{ github.repository }}

      - name: Check for Usage Increase
        id: usage_check
        run: |
          python3 << 'PYTHON_SCRIPT'
          import os
          
          prev_cpu = float("${{ steps.previous_metrics.outputs.previous_cpu }}" or "0")
          curr_cpu = float("${{ steps.current_metrics.outputs.current_cpu }}" or "0")
          prev_mem = float("${{ steps.previous_metrics.outputs.previous_memory }}" or "0")
          curr_mem = float("${{ steps.current_metrics.outputs.current_memory }}" or "0")
          prev_redis = float("${{ steps.previous_metrics.outputs.previous_redis }}" or "0")
          curr_redis = float("${{ steps.current_metrics.outputs.current_redis }}" or "0")
          
          # ì¦ê°€ìœ¨ ê³„ì‚°
          cpu_increase = ((curr_cpu - prev_cpu) / prev_cpu * 100) if prev_cpu > 0 else 0
          mem_increase = ((curr_mem - prev_mem) / prev_mem * 100) if prev_mem > 0 else 0
          redis_increase = ((curr_redis - prev_redis) / prev_redis * 100) if prev_redis > 0 else 0
          
          # 10% ì´ìƒ ì¦ê°€í•œ ê²½ìš° ì•Œë¦¼
          alert_needed = cpu_increase > 10 or mem_increase > 10 or redis_increase > 10
          alert_messages = []
          
          if cpu_increase > 10:
              alert_messages.append(f"âš ï¸ CPU ì‚¬ìš©ë¥ ì´ {cpu_increase:.2f}% ì¦ê°€í–ˆìŠµë‹ˆë‹¤ ({prev_cpu:.2f}% â†’ {curr_cpu:.2f}%)")
          if mem_increase > 10:
              alert_messages.append(f"âš ï¸ ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ ì´ {mem_increase:.2f}% ì¦ê°€í–ˆìŠµë‹ˆë‹¤ ({prev_mem:.2f}GB â†’ {curr_mem:.2f}GB)")
          if redis_increase > 10:
              alert_messages.append(f"âš ï¸ Redis ì‚¬ìš©ë¥ ì´ {redis_increase:.2f}% ì¦ê°€í–ˆìŠµë‹ˆë‹¤ ({prev_redis:.2f}% â†’ {curr_redis:.2f}%)")
          
          # GitHub Actions outputì— ì“°ê¸°
          output_file = os.environ.get('GITHUB_OUTPUT', '/dev/stdout')
          with open(output_file, 'a') as f:
              f.write(f"alert_needed={str(alert_needed).lower()}\n")
              f.write(f"cpu_increase={cpu_increase:.2f}\n")
              f.write(f"mem_increase={mem_increase:.2f}\n")
              f.write(f"redis_increase={redis_increase:.2f}\n")
              if alert_messages:
                  f.write("alert_messages<<EOF\n")
                  f.write("\n".join(alert_messages) + "\n")
                  f.write("EOF\n")
          PYTHON_SCRIPT

      - name: Send Usage Increase Alert
        if: steps.usage_check.outputs.alert_needed == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ] || [ "$SLACK_WEBHOOK_URL" = "" ]; then
            echo "âš ï¸ SLACK_WEBHOOK_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 0
          fi
          
          ALERT_MSGS="${{ steps.usage_check.outputs.alert_messages }}"
          ALERT_MSGS_ESCAPED=$(echo "$ALERT_MSGS" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed 's/`/\\`/g')
          
          PAYLOAD=$(cat <<JSON
          {
            "text": "âš ï¸ ì‹œìŠ¤í…œ ì‚¬ìš©ë¥  ì¦ê°€ ì•Œë¦¼",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "âš ï¸ ì‹œìŠ¤í…œ ì‚¬ìš©ë¥  ì¦ê°€ ì•Œë¦¼"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "${ALERT_MSGS_ESCAPED}"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*ğŸ“Š í˜„ì¬ CPU:*\n${{ steps.current_metrics.outputs.current_cpu }}%"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ğŸ’¾ í˜„ì¬ ë©”ëª¨ë¦¬:*\n${{ steps.current_metrics.outputs.current_memory }}GB"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ğŸ”´ Redis ì‚¬ìš©ë¥ :*\n${{ steps.current_metrics.outputs.current_redis }}%"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ğŸ• í™•ì¸ ì‹œê°„:*\n$(date -u +'%Y-%m-%d %H:%M:%S UTC')"
                  }
                ]
              }
            ]
          }
          JSON
          )
          
          curl -X POST -H 'Content-type: application/json' \
            --data "$PAYLOAD" \
            "$SLACK_WEBHOOK_URL" && echo "âœ… ì‚¬ìš©ë¥  ì¦ê°€ ì•Œë¦¼ ì „ì†¡ ì„±ê³µ" || echo "âš ï¸ ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨"

      - name: Send Monitoring Report
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ] || [ "$SLACK_WEBHOOK_URL" = "" ]; then
            echo "âš ï¸ SLACK_WEBHOOK_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 0
          fi
          
          REPORT_TIME=$(date -u +'%Y-%m-%d %H:%M:%S UTC')
          
          PAYLOAD=$(cat <<JSON
          {
            "text": "ğŸ“Š ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§ ë¦¬í¬íŠ¸",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "ğŸ“Š ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§ ë¦¬í¬íŠ¸"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*6ì‹œê°„ë§ˆë‹¤ ìë™ìœ¼ë¡œ ìˆ˜ì§‘ë˜ëŠ” ì‹œìŠ¤í…œ ë©”íŠ¸ë¦­ ë¦¬í¬íŠ¸ì…ë‹ˆë‹¤.*"
                }
              },
              {
                "type": "divider"
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*ğŸ–¥ï¸ CPU ì‚¬ìš©ë¥ *\n\`${{ steps.current_metrics.outputs.current_cpu }}%\`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ğŸ’¾ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰*\n\`${{ steps.current_metrics.outputs.current_memory }}GB\`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ğŸ”´ Redis ì‚¬ìš©ë¥ *\n\`${{ steps.current_metrics.outputs.current_redis }}%\`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ğŸ˜ PostgreSQL ì—°ê²° ìˆ˜*\n\`${{ steps.current_metrics.outputs.current_postgres }}\`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ğŸ“¡ HTTP ìš”ì²­ë¥  (1ë¶„ë‹¹)*\n\`${{ steps.current_metrics.outputs.current_http_rate }}\`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*âŒ ì—ëŸ¬ìœ¨ (1ë¶„ë‹¹)*\n\`${{ steps.current_metrics.outputs.current_error_rate }}\`"
                  }
                ]
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*ğŸ“ˆ CPU ì¦ê°€ìœ¨*\n\`${{ steps.usage_check.outputs.cpu_increase }}%\`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ğŸ“ˆ ë©”ëª¨ë¦¬ ì¦ê°€ìœ¨*\n\`${{ steps.usage_check.outputs.mem_increase }}%\`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ğŸ“ˆ Redis ì¦ê°€ìœ¨*\n\`${{ steps.usage_check.outputs.redis_increase }}%\`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ğŸ• ë¦¬í¬íŠ¸ ì‹œê°„*\n\`${REPORT_TIME}\`"
                  }
                ]
              },
              {
                "type": "context",
                "elements": [
                  {
                    "type": "mrkdwn",
                    "text": "ğŸ“Š ì„œë²„: ${{ env.EC2_HOST }} | ğŸƒ ì‹¤í–‰ ID: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|#${{ github.run_number }}>"
                  }
                ]
              }
            ]
          }
          JSON
          )
          
          curl -X POST -H 'Content-type: application/json' \
            --data "$PAYLOAD" \
            "$SLACK_WEBHOOK_URL" && echo "âœ… ëª¨ë‹ˆí„°ë§ ë¦¬í¬íŠ¸ ì „ì†¡ ì„±ê³µ" || echo "âš ï¸ ë¦¬í¬íŠ¸ ì „ì†¡ ì‹¤íŒ¨"
