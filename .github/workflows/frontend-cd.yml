name: Frontend CD - Vercel Deployment Notification

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - 'vercel.json'
      - '.github/workflows/frontend-cd.yml'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  notify:
    name: Notify Vercel Deployment Status
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get deployment details
        id: deployment_details
        run: |
          # ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ JSON-safeí•˜ê²Œ ì´ìŠ¤ì¼€ì´í”„
          COMMIT_MSG=$(git log -1 --pretty=%B | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g' | head -c 500)
          echo "commit_message=$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "commit_author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
          echo "deployment_time=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
          echo "commit_sha=${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT

      - name: Check Vercel Deployment Status
        id: vercel_status
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          # Vercel APIë¥¼ ì‚¬ìš©í•˜ì—¬ ìµœì‹  ë°°í¬ ìƒíƒœ í™•ì¸
          if [ -z "$VERCEL_TOKEN" ] || [ -z "$VERCEL_PROJECT_ID" ]; then
            echo "âš ï¸ Vercel í† í°ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë°°í¬ ìƒíƒœ í™•ì¸ì„ ê±´ë„ˆëœë‹ˆë‹¤."
            echo "status=unknown" >> $GITHUB_OUTPUT
            echo "deployment_url=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # ìµœì‹  ë°°í¬ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          DEPLOYMENT_RESPONSE=$(curl -s -X GET \
            "https://api.vercel.com/v6/deployments?projectId=${VERCEL_PROJECT_ID}&limit=1" \
            -H "Authorization: Bearer ${VERCEL_TOKEN}" \
            -H "Content-Type: application/json" || echo "{}")
          
          # ë°°í¬ ìƒíƒœ íŒŒì‹±
          DEPLOYMENT_STATE=$(echo "$DEPLOYMENT_RESPONSE" | grep -o '"state":"[^"]*"' | head -1 | cut -d'"' -f4 || echo "unknown")
          DEPLOYMENT_URL=$(echo "$DEPLOYMENT_RESPONSE" | grep -o '"url":"[^"]*"' | head -1 | cut -d'"' -f4 || echo "")
          
          echo "status=$DEPLOYMENT_STATE" >> $GITHUB_OUTPUT
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          
          if [ "$DEPLOYMENT_STATE" = "READY" ]; then
            echo "âœ… Vercel ë°°í¬ ì„±ê³µ ê°ì§€"
          elif [ "$DEPLOYMENT_STATE" = "ERROR" ] || [ "$DEPLOYMENT_STATE" = "CANCELED" ]; then
            echo "âŒ Vercel ë°°í¬ ì‹¤íŒ¨ ê°ì§€: $DEPLOYMENT_STATE"
          else
            echo "â„¹ï¸ Vercel ë°°í¬ ìƒíƒœ: $DEPLOYMENT_STATE"
          fi

      - name: Slack Notification
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # Slack Webhook URLì´ ì—†ìœ¼ë©´ ìŠ¤í‚µ
          if [ -z "$SLACK_WEBHOOK_URL" ] || [ "$SLACK_WEBHOOK_URL" = "" ]; then
            echo "âš ï¸ SLACK_WEBHOOK_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Slack ì•Œë¦¼ì„ ê±´ë„ˆëœë‹ˆë‹¤."
            exit 0
          fi
          
          # ë°°í¬ ìƒíƒœì— ë”°ë¥¸ ë©”ì‹œì§€ ì„¤ì •
          DEPLOYMENT_STATE="${{ steps.vercel_status.outputs.status }}"
          
          if [ "$DEPLOYMENT_STATE" = "READY" ]; then
            STATUS_EMOJI="âœ…"
            STATUS_TEXT="ì„±ê³µ"
            FUN_MESSAGE="ğŸ‰ *í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì™„ë£Œ!*"
            COLOR="good"
          elif [ "$DEPLOYMENT_STATE" = "ERROR" ] || [ "$DEPLOYMENT_STATE" = "CANCELED" ]; then
            STATUS_EMOJI="âŒ"
            STATUS_TEXT="ì‹¤íŒ¨"
            FUN_MESSAGE="ğŸ’¥ *í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì‹¤íŒ¨*"
            COLOR="danger"
          else
            STATUS_EMOJI="â³"
            STATUS_TEXT="ì§„í–‰ ì¤‘"
            FUN_MESSAGE="ğŸ”„ *í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì¤‘...*"
            COLOR="warning"
          fi
          
          # ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ JSON-safeí•˜ê²Œ ì²˜ë¦¬
          COMMIT_MSG="${{ steps.deployment_details.outputs.commit_message }}"
          COMMIT_MSG_ESCAPED=$(echo "$COMMIT_MSG" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed 's/`/\\`/g' | sed 's/\$/\\$/g')
          
          DEPLOYMENT_URL="${{ steps.vercel_status.outputs.deployment_url }}"
          if [ -n "$DEPLOYMENT_URL" ] && [ "$DEPLOYMENT_URL" != "" ]; then
            DEPLOYMENT_LINK="<$DEPLOYMENT_URL|$DEPLOYMENT_URL>"
          else
            DEPLOYMENT_LINK="N/A"
          fi
          
          # JSON payload ìƒì„±
          PAYLOAD=$(cat <<JSON
          {
            "text": "ğŸš€ í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ${STATUS_TEXT}",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "${STATUS_EMOJI} í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ${STATUS_TEXT}"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "${FUN_MESSAGE}"
                }
              },
              {
                "type": "divider"
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*ğŸ“‹ ì›Œí¬í”Œë¡œìš°:*\nFrontend CD - Vercel Deployment"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ğŸŒ¿ ë¸Œëœì¹˜:*\n\`${{ github.ref_name }}\`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ğŸ“¦ ì»¤ë°‹:*\n<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|\`${{ steps.deployment_details.outputs.commit_sha }}\`>"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ğŸ‘¤ ì‘ì„±ì:*\n${{ github.actor }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ğŸ• ë°°í¬ ì‹œê°„:*\n${{ steps.deployment_details.outputs.deployment_time }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ğŸƒ ì‹¤í–‰ ID:*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|#${{ github.run_number }}>"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ğŸŒ ë°°í¬ URL:*\n${DEPLOYMENT_LINK}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ğŸ“Š ë°°í¬ ìƒíƒœ:*\n\`${DEPLOYMENT_STATE}\`"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*ğŸ’¬ ì»¤ë°‹ ë©”ì‹œì§€:*\n\`\`\`${COMMIT_MSG_ESCAPED}\`\`\`"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*ğŸ”— ìƒì„¸ ì •ë³´:*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|GitHub Actionsì—ì„œ í™•ì¸í•˜ê¸°>"
                }
              },
              {
                "type": "context",
                "elements": [
                  {
                    "type": "mrkdwn",
                    "text": "ğŸ“Š ì €ì¥ì†Œ: <${{ github.server_url }}/${{ github.repository }}|${{ github.repository }}>"
                  }
                ]
              }
            ]
          }
          JSON
          )
          
          # JSON ìœ íš¨ì„± ê²€ì‚¬ ë° ì „ì†¡
          echo "$PAYLOAD" | python3 -m json.tool > /dev/null 2>&1
          if [ $? -eq 0 ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "$PAYLOAD" \
              "$SLACK_WEBHOOK_URL" && echo "âœ… Slack ì•Œë¦¼ ì „ì†¡ ì„±ê³µ" || echo "âš ï¸ Slack ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨"
          else
            echo "âŒ JSON payloadê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê°„ë‹¨í•œ ë©”ì‹œì§€ë¡œ ì „ì†¡í•©ë‹ˆë‹¤."
            SIMPLE_PAYLOAD="{\"text\": \"ğŸš€ í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ${STATUS_TEXT} - ${{ github.ref_name }} - ${{ github.actor }}\"}"
            curl -X POST -H 'Content-type: application/json' \
              --data "$SIMPLE_PAYLOAD" \
              "$SLACK_WEBHOOK_URL" || echo "âš ï¸ Slack ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨"
          fi
