# π” κ²€μƒ‰ API (Search)

μ•„ννΈ κ²€μƒ‰ λ° AI μμ—°μ–΄ κ²€μƒ‰ APIλ¥Ό μ„¤λ…ν•©λ‹λ‹¤.

---

## κ°μ”

μ‚¬μ©μκ°€ μ•„ννΈλ¥Ό κ²€μƒ‰ν•  μ μλ” λ‘ κ°€μ§€ λ°©μ‹μ„ μ κ³µν•©λ‹λ‹¤:

1. **μΌλ° κ²€μƒ‰**: ν‚¤μ›λ“ κΈ°λ° κ²€μƒ‰
2. **AI κ²€μƒ‰**: μμ—°μ–΄λ΅ κ²€μƒ‰ μ΅°κ±΄ μλ™ λ¶„μ„

---

## API μ—”λ“ν¬μΈνΈ

### 1. μ•„ννΈ κ²€μƒ‰

ν‚¤μ›λ“λ΅ μ•„ννΈλ¥Ό κ²€μƒ‰ν•©λ‹λ‹¤.

**μ”μ²­**

```http
GET /api/v1/search
Authorization: Bearer <jwt_token>
```

**μΏΌλ¦¬ νλΌλ―Έν„°**

| νλΌλ―Έν„° | νƒ€μ… | ν•„μ | κΈ°λ³Έκ°’ | μ„¤λ… |
|----------|------|------|--------|------|
| q | string | β“ | - | κ²€μƒ‰μ–΄ (μ•„ννΈλ…, μ£Όμ†) |
| limit | int | - | 10 | κ²°κ³Ό μ (μµλ€ 50) |
| region_id | int | - | - | μ§€μ—­ IDλ΅ ν•„ν„°λ§ |

**μ‘λ‹µ (200 OK)**

```json
{
  "success": true,
  "data": {
    "results": [
      {
        "apt_id": 12345,
        "apt_name": "λλ―Έμ• κ°•λ‚¨ νν¬μ¤μ„νΈ",
        "region_name": "μ„μΈνΉλ³„μ‹ κ°•λ‚¨κµ¬ μ—­μ‚Όλ™",
        "road_address": "μ„μΈνΉλ³„μ‹ κ°•λ‚¨κµ¬ ν…ν—¤λ€λ΅ 123",
        "avg_sale_price": 150000,
        "avg_jeonse_price": 80000,
        "similarity": 0.95
      },
      {
        "apt_id": 12346,
        "apt_name": "λλ―Έμ• μ„μ΄ μ„ΌνΈλ΄",
        "region_name": "μ„μΈνΉλ³„μ‹ μ„μ΄κµ¬ μ„μ΄λ™",
        "road_address": "μ„μΈνΉλ³„μ‹ μ„μ΄κµ¬ μ„μ΄λ€λ΅ 456",
        "avg_sale_price": 140000,
        "avg_jeonse_price": 75000,
        "similarity": 0.85
      }
    ],
    "total": 2
  }
}
```

**κ²€μƒ‰ μ•κ³ λ¦¬μ¦**

1. **1λ‹¨κ³„**: PREFIX κ²€μƒ‰ (μΈλ±μ¤ ν™μ©, λΉ λ¦„)
   - `apt_name LIKE 'λλ―Έμ•%'`
2. **2λ‹¨κ³„**: μ μ‚¬λ„ κ²€μƒ‰ (pg_trgm, κ²°κ³Ό λ¶€μ΅± μ‹)
   - `similarity(apt_name, 'λλ―Έμ•') > 0.3`

---

### 2. AI μμ—°μ–΄ κ²€μƒ‰

μμ—°μ–΄λ΅ κ²€μƒ‰ μ΅°κ±΄μ„ μλ™ λ¶„μ„ν•©λ‹λ‹¤.

**μ”μ²­**

```http
POST /api/v1/search/ai
Authorization: Bearer <jwt_token>
Content-Type: application/json
```

```json
{
  "query": "κ°•λ‚¨μ—­ κ·Όμ² 3μ–µ μ΄ν• μ „μ„Έ"
}
```

**μ‘λ‹µ (200 OK)**

```json
{
  "success": true,
  "data": {
    "parsed_conditions": {
      "location": "κ°•λ‚¨μ—­",
      "max_price": 30000,
      "transaction_type": "jeonse",
      "radius_km": 1
    },
    "results": [
      {
        "apt_id": 12345,
        "apt_name": "λλ―Έμ• κ°•λ‚¨ νν¬μ¤μ„νΈ",
        "region_name": "μ„μΈνΉλ³„μ‹ κ°•λ‚¨κµ¬ μ—­μ‚Όλ™",
        "distance_km": 0.5,
        "avg_jeonse_price": 28000,
        "match_score": 0.92
      }
    ],
    "total": 15
  }
}
```

**μ§€μ› μ΅°κ±΄**

| μ΅°κ±΄ | μμ‹ |
|------|------|
| μ„μΉ | "κ°•λ‚¨μ—­", "μ„μ΄κµ¬", "νκµ" |
| κ°€κ²© | "3μ–µ μ΄ν•", "5μ–µ~10μ–µ" |
| κ±°λ μ ν• | "μ „μ„Έ", "λ§¤λ§¤", "μ›”μ„Έ" |
| λ©΄μ  | "30ν‰ μ΄μƒ", "20ν‰λ€" |
| κ±°λ¦¬ | "λ„λ³΄ 10λ¶„ μ΄λ‚΄", "1km μ΄λ‚΄" |

**Gemini API μ‚¬μ©**

```python
async def parse_natural_language(query: str) -> SearchParams:
    """μμ—°μ–΄λ¥Ό κµ¬μ΅°ν™”λ κ²€μƒ‰ μ΅°κ±΄μΌλ΅ λ³€ν™"""
    prompt = f"""
    λ¶€λ™μ‚° κ²€μƒ‰ μΏΌλ¦¬λ¥Ό λ¶„μ„ν•μ„Έμ”: "{query}"
    
    JSON ν•μ‹μΌλ΅ λ°ν™:
    {{
        "location": "μ§€μ—­λ…",
        "max_price": κ°€κ²©(λ§μ›),
        "min_price": κ°€κ²©(λ§μ›),
        "transaction_type": "sale|jeonse|monthly",
        "min_area_pyeong": λ©΄μ (ν‰),
        "radius_km": λ°κ²½(km)
    }}
    """
    response = await gemini.generate(prompt)
    return SearchParams(**json.loads(response))
```

---

### 3. μµκ·Ό κ²€μƒ‰ κΈ°λ΅

μ‚¬μ©μμ μµκ·Ό κ²€μƒ‰ κΈ°λ΅μ„ λ°ν™ν•©λ‹λ‹¤.

**μ”μ²­**

```http
GET /api/v1/search/recent
Authorization: Bearer <jwt_token>
```

**μ‘λ‹µ (200 OK)**

```json
{
  "success": true,
  "data": {
    "searches": [
      {
        "search_id": 1,
        "query": "λλ―Έμ•",
        "searched_at": "2024-01-15T10:30:00Z"
      },
      {
        "search_id": 2,
        "query": "κ°•λ‚¨μ—­ μ „μ„Έ",
        "searched_at": "2024-01-15T09:00:00Z"
      }
    ]
  }
}
```

---

### 4. μµκ·Ό λ³Έ μ•„ννΈ

μ‚¬μ©μκ°€ μµκ·Ό μ΅°νν• μ•„ννΈ λ©λ΅μ„ λ°ν™ν•©λ‹λ‹¤.

**μ”μ²­**

```http
GET /api/v1/search/recent-views
Authorization: Bearer <jwt_token>
```

**μΏΌλ¦¬ νλΌλ―Έν„°**

| νλΌλ―Έν„° | νƒ€μ… | κΈ°λ³Έκ°’ | μ„¤λ… |
|----------|------|--------|------|
| limit | int | 10 | κ²°κ³Ό μ (μµλ€ 50) |

**μ‘λ‹µ (200 OK)**

```json
{
  "success": true,
  "data": {
    "apartments": [
      {
        "apt_id": 12345,
        "apt_name": "λλ―Έμ• κ°•λ‚¨ νν¬μ¤μ„νΈ",
        "region_name": "μ„μΈνΉλ³„μ‹ κ°•λ‚¨κµ¬ μ—­μ‚Όλ™",
        "viewed_at": "2024-01-15T10:30:00Z"
      }
    ]
  }
}
```

---

## κ²€μƒ‰ μ„±λ¥ μµμ ν™”

### 2λ‹¨κ³„ κ²€μƒ‰ μ•κ³ λ¦¬μ¦

```
κ²€μƒ‰μ–΄: "λλ―Έμ•"

1λ‹¨κ³„: PREFIX κ²€μƒ‰ (μΈλ±μ¤)
  β†’ κ²°κ³Ό: ["λλ―Έμ•κ°•λ‚¨", "λλ―Έμ•μ„μ΄", ...] (10κ°)
  β†’ 10κ° μ΄μƒμ΄λ©΄ λ°ν™

2λ‹¨κ³„: μ μ‚¬λ„ κ²€μƒ‰ (pg_trgm)
  β†’ κ²°κ³Ό λ¶€μ΅± μ‹ μ¶”κ°€ κ²€μƒ‰
  β†’ μ μ‚¬λ„ 0.3 μ΄μƒ ν•„ν„°
```

### μ„±λ¥ λΉ„κµ

| λ°©μ‹ | κ²€μƒ‰ μ‹κ°„ | κ²°κ³Ό ν’μ§ |
|------|----------|----------|
| LIKE '%keyword%' | 2-3μ΄ | μ •ν™• |
| pg_trgmλ§ | 500ms | μ μ‚¬λ„ ν¬ν•¨ |
| **2λ‹¨κ³„ κ²€μƒ‰** | **50-100ms** | **μµμ ** |

---

## μΊμ‹± μ •λ³΄

| μ—”λ“ν¬μΈνΈ | TTL | μ„¤λ… |
|-----------|-----|------|
| /search | 5λ¶„ | κ²€μƒ‰ κ²°κ³Ό μΊμ‹± |
| /search/ai | 10λ¶„ | AI λ¶„μ„ κ²°κ³Ό μΊμ‹± |

---

## μ—λ¬ μ½”λ“

| HTTP μƒνƒ | μ½”λ“ | μ„¤λ… |
|-----------|------|------|
| 400 | QUERY_TOO_SHORT | κ²€μƒ‰μ–΄κ°€ λ„λ¬΄ μ§§μ (2μ μ΄μƒ) |
| 400 | QUERY_TOO_LONG | κ²€μƒ‰μ–΄κ°€ λ„λ¬΄ κΉ€ (100μ μ΄ν•) |
| 503 | AI_SERVICE_UNAVAILABLE | Gemini API νΈμ¶ μ‹¤ν¨ |
| 504 | AI_TIMEOUT | Gemini API νƒ€μ„μ•„μ›ƒ (30μ΄) |
