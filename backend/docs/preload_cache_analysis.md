# 서버 시작 시 홈 화면 캐싱 기능 분석

## 📋 개요
서버 시작 시 홈 화면 지표들을 TTL 12시간으로 미리 캐싱하는 기능에 대한 타당성 분석 및 구현 방안

## 🎯 현재 상황
- **현재 상태**: 사용자가 홈 화면에 들어가야 Redis 캐싱이 됨 (cold start 문제)
- **캐시 TTL**: 30분 (1800초)
- **주요 API**: 
  - `/api/v1/dashboard/summary` - 대시보드 요약 데이터
  - `/api/v1/dashboard/rankings` - 랭킹 데이터

## ✅ 장점 분석

### 1. 사용자 경험 개선
- **첫 사용자 응답 시간 단축**: 서버 재시작 직후 첫 요청이 빠르게 응답됨
- **Cold Start 문제 해결**: 서버 시작 직후 바로 사용 가능한 상태로 준비
- **예측 가능한 성능**: 항상 캐시가 준비되어 있어 응답 시간이 일관됨

### 2. 서버 부하 분산
- **시작 시 부하 처리**: 서버 시작 직후 모든 요청을 동시에 처리하는 대신 미리 준비
- **DB 부하 감소**: 첫 사용자 요청 시 DB 쿼리 부하를 피할 수 있음
- **안정적인 서비스 제공**: 트래픽 급증 시에도 안정적으로 응답 가능

### 3. 비즈니스 가치
- **이탈률 감소**: 느린 첫 로딩으로 인한 사용자 이탈 감소
- **서비스 품질 향상**: 사용자에게 항상 빠른 경험 제공

## ⚠️ 단점 및 고려사항

### 1. 서버 시작 시간
- **문제**: 서버 시작 시 캐싱 작업을 수행하면 시작 시간이 늘어날 수 있음
- **해결책**: 백그라운드 태스크로 비동기 실행 (서버 시작을 블로킹하지 않음)
- **영향**: 거의 없음 (비동기로 처리하므로)

### 2. 메모리 사용량
- **문제**: Redis 메모리 사용량 증가
- **영향**: 최소 (홈 화면 데이터는 크지 않음, 대략 수십 KB 수준)
- **고려사항**: Redis 메모리 모니터링 필요

### 3. 데이터 신선도
- **문제**: TTL 12시간은 꽤 긴 시간
- **분석**: 홈 화면 데이터는 실시간성이 낮음 (부동산 데이터는 하루에 한두 번 업데이트)
- **결론**: 12시간 TTL은 적절함

## 💡 구현 방안 비교

### 방안 1: startup_event에서 백그라운드 태스크 실행 ✅ **권장**
**장점:**
- 서버 시작 시 자동 실행 (관리 편의성)
- 백그라운드 실행으로 서버 시작 블로킹 없음
- 코드가 단순하고 유지보수 용이

**단점:**
- 서버 시작 시 항상 실행 (선택적 실행 불가)

**구현:**
```python
@app.on_event("startup")
async def startup_event():
    # ... 기존 코드 ...
    
    # 백그라운드 태스크로 캐싱 실행
    asyncio.create_task(preload_home_cache())
```

### 방안 2: 별도 엔드포인트 (Etc 카테고리)
**장점:**
- 수동으로 캐시 갱신 가능
- 선택적 실행 가능

**단점:**
- 수동 호출 필요 (자동화 어려움)
- 관리 부담 증가
- 서버 시작 시 자동 실행하려면 여전히 startup_event 필요

**결론**: 별도 엔드포인트는 필요하지 않음. 서버 시작 시 자동 실행이 더 효율적

## 🎯 최종 권장 사항

### ✅ **타당성**: 매우 타당함
1. 홈 화면은 가장 많이 접근되는 페이지
2. 데이터 업데이트 빈도가 낮아 긴 TTL이 적절
3. Cold Start 문제를 해결하여 사용자 경험 향상
4. 구현 비용이 낮고 효과가 큼

### ✅ **구현 방법**: startup_event에서 백그라운드 태스크 실행
- `asyncio.create_task()`로 비동기 실행
- 서버 시작을 블로킹하지 않음
- 에러 처리 및 로깅 포함

### ✅ **TTL**: 12시간 (43200초) 적절
- 홈 화면 데이터는 자주 변하지 않음
- 부동산 데이터 특성상 하루에 한두 번 업데이트
- 12시간 TTL은 데이터 신선도와 성능의 좋은 균형

## 📊 예상 효과

### 성능 개선
- **첫 요청 응답 시간**: ~3-5초 → ~50-100ms (캐시 히트)
- **DB 쿼리 감소**: 첫 사용자 요청 시 DB 쿼리 0건
- **서버 부하 감소**: 동시 요청 처리 능력 향상

### 사용자 경험
- **이탈률 감소**: 빠른 로딩으로 인한 사용자 이탈 감소 예상
- **만족도 향상**: 항상 빠른 응답 제공

## 🔧 구현 세부 사항

### 캐싱할 API 목록
1. `/api/v1/dashboard/summary?transaction_type=sale&months=6`
2. `/api/v1/dashboard/summary?transaction_type=jeonse&months=6`
3. `/api/v1/dashboard/rankings?transaction_type=sale`
4. `/api/v1/dashboard/rankings?transaction_type=jeonse`

### 에러 처리
- 캐싱 실패 시에도 서버 시작은 정상 진행
- 로깅을 통해 실패 사유 추적
- 재시도 로직은 불필요 (서버 시작 시 한 번만 실행)

### 모니터링
- 캐싱 성공/실패 로그 기록
- Prometheus 메트릭으로 캐싱 성능 모니터링 가능
