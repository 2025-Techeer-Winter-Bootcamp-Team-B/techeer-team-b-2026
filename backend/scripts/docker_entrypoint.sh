#!/bin/bash
# ============================================================
# Docker ?트리포?트 ?크립트
# 1. ?이?베?스 ?결 ??
# 2. ?동 마이그레?션 ?행
# 3. FastAPI ?버 ?작
# ============================================================

echo "?? Docker ?트리포?트 ?작..."

# --------------------------------------------------------
# 1. ?이?베?스 ?결 ??
# --------------------------------------------------------
echo "???이?베?스 ?결 ???.."

# DATABASE_URL?서 ?스?? ?트 추출
DB_HOST=$(echo "$DATABASE_URL" | sed -n 's/.*@\([^:]*\):.*/\1/p')
DB_PORT=$(echo "$DATABASE_URL" | sed -n 's/.*:\([0-9]*\)\/.*/\1/p')

if [ -z "$DB_HOST" ]; then
    DB_HOST="db"
fi

if [ -z "$DB_PORT" ]; then
    DB_PORT="5432"
fi

echo "? ?이?베?스: $DB_HOST:$DB_PORT"

# Python ?크립트?DB ?결 ??(최? 60?
if python /app/scripts/wait_for_db.py "$DB_HOST" "$DB_PORT" 60; then
    # 추? ??(DB가 ?전??준비될 ?까지)
    echo "???이?베?스 초기????(3?..."
    sleep 3
else
    echo "?️  ?이?베?스 ?결 ?패, 마이그레?션 건너?"
    echo "?? FastAPI ?버 ?작..."
    exec "$@"
fi

# --------------------------------------------------------
# 2. ?동 마이그레?션 ?행
# --------------------------------------------------------
echo ""
echo "? ?동 마이그레?션 ?행 ?.."

if python /app/scripts/auto_migrate.py; then
    echo "??마이그레?션 ?료!"
else
    echo "?️  마이그레?션 경고 (?버??계속 ?작?니??"
fi

# --------------------------------------------------------
# 3. FastAPI ?버 ?작
# --------------------------------------------------------
echo ""
echo "?? FastAPI ?버 ?작..."
echo "=================================================="

# ?달받? 명령???행 (기본: uvicorn)
exec "$@"
