# 아파트 ID 불일치 문제 근본 원인 분석

## 문제 현상
- `apart_details` 테이블의 `apt_id`가 실제 `apartments` 테이블의 `apt_id`보다 2만큼 작음
- 예시:
  - 힐스테이트 상세정보(FK 5419) -> 실제 힐스테이트(ID 5421) : 차이 -2
  - 가든하이츠 상세정보(FK 5417) -> 실제 가든하이츠(ID 5419) : 차이 -2
- 처음 몇백 개는 정상, 중간부터 어그러짐
- 429 에러 발생 후 API 키를 바꿔서 재수집 진행

## 근본 원인 분석

### 1. 아파트 수집 과정에서 발생한 문제

**시나리오:**
1. `apartments` 테이블에 아파트를 순차적으로 수집 (apt_id: 5417, 5418, 5419, 5420, 5421, ...)
2. 중간에 429 에러 발생 또는 트랜잭션 롤백으로 인해 일부 레코드가 삭제됨
   - 예: apt_id 5418, 5420이 삭제됨
3. 결과적으로 `apartments` 테이블에는 apt_id 5417, 5419, 5421만 존재
4. 이후 `apart_details` 수집 시:
   - 상세 정보 수집 로직이 `apartments` 테이블을 순차적으로 조회
   - 하지만 삭제된 레코드 때문에 실제 apt_id와 매칭이 어긋남
   - 예: 상세 정보가 apt_id 5417을 참조하려 했지만, 실제로는 5419를 참조해야 함

### 2. 가능한 원인들

#### 원인 A: 트랜잭션 롤백
- 아파트 수집 중 에러 발생 → 트랜잭션 롤백
- 일부 레코드는 커밋되었지만, 일부는 롤백됨
- 시퀀스는 계속 증가하므로 apt_id에 간격 발생

#### 원인 B: 429 에러 후 재시도
- 429 에러 발생 → API 키 변경 후 재수집
- 재수집 과정에서 중복 체크로 인해 일부 레코드는 건너뛰고, 일부는 새로 생성
- 이 과정에서 apt_id 매핑이 어긋남

#### 원인 C: 동시성 문제
- 여러 프로세스가 동시에 수집하는 경우
- Race condition으로 인해 일부 레코드가 중복 생성되거나 삭제됨

### 3. 어느 쪽의 문제인가?

**결론: `apartments` 테이블의 문제**

이유:
1. `apartments` 테이블의 apt_id에 간격이 있음 (5417, 5419, 5421 - 5418, 5420 누락)
2. `apart_details`는 `apartments`의 apt_id를 참조하므로, 원본 데이터가 잘못되면 참조도 잘못됨
3. 상세 정보 수집 시 `get_multi_missing_details()` 쿼리가 순차적으로 조회하므로,
   삭제된 레코드 때문에 실제 매칭이 어긋날 수 있음

## 해결 방법

### 즉시 해결 (기존 스크립트 사용)
```bash
# 1. 문제 분석
python backend/scripts/analyze_apt_id_mismatch.py

# 2. 데이터 수정
python backend/scripts/fix_data_mismatch.py
```

### 근본적 해결 (향후 방지)

1. **아파트 수집 시 kapt_code 기반 매칭 강화**
   - `apart_details` 수집 시 `apt_id`가 아닌 `kapt_code`로 매칭
   - 이렇게 하면 apt_id 간격과 무관하게 정확한 매칭 가능

2. **트랜잭션 관리 개선**
   - 작은 배치 단위로 커밋하여 롤백 범위 최소화
   - Savepoint 사용으로 부분 롤백 가능

3. **429 에러 처리 개선**
   - 재시도 시 중복 체크를 `kapt_code` 기반으로 수행
   - apt_id가 아닌 kapt_code로 매칭하여 ID 간격 문제 회피

4. **데이터 무결성 검증**
   - 수집 후 자동으로 불일치 검사
   - 주기적으로 `analyze_apt_id_mismatch.py` 실행

## 권장 사항

1. **즉시 실행**: `fix_data_mismatch.py`로 현재 데이터 수정
2. **코드 개선**: `apart_details` 수집 로직을 `kapt_code` 기반으로 변경
3. **모니터링**: 정기적으로 불일치 검사 수행
